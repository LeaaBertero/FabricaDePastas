@page "/catalogo-usuario"
@inject IHTTPServicio http
@inject CarritoServicio carritoServicio
@inject NavigationManager navigationManager

<div class="container py-4">

    <!-- 🔹 Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold text-danger">
            🍝 Catálogo de Productos
        </h1>

        <button class="btn btn-outline-primary fw-semibold" @onclick="VolverInicio">
            <i class="bi bi-arrow-left-circle"></i> Volver al inicio
        </button>
    </div>

    <!-- 🔹 Listado de productos -->
    @if (productos == null)
    {
        <div class="text-center text-muted mt-5">
            <div class="spinner-border text-danger mb-3"></div>
            <p>Cargando productos...</p>
        </div>
    }
    else if (!productos.Any())
    {
        <p class="text-center text-muted">No hay productos disponibles.</p>
    }
    else
    {
        <div class="row row-cols-1 row-cols-md-3 g-4">
            @foreach (var p in productos)
            {
                <div class="col">
                    <div class="card h-100 shadow-sm border-0">

                        <!-- ✅ CAMBIO: ahora la imagen usa la URL base de la app -->
                        <!-- Esto garantiza que si la imagen está en wwwroot/images, se mostrará correctamente -->
                        <img src="@($"{navigationManager.BaseUri.TrimEnd('/')}{p.Imagen_Url}")"
                             class="card-img-top rounded-top"
                             alt="@p.Nombre"
                             style="object-fit: cover; height: 220px;">
                        <!-- 🟢 Fin del cambio -->

                        <div class="card-body">
                            <h5 class="card-title text-danger fw-bold">@p.Nombre</h5>
                            <p class="card-text text-secondary">@p.Descripcion</p>
                            <p class="fw-bold text-success fs-5">💲@p.PrecioBase</p>

                            <!-- 🔹 Selector de cantidad -->
                            <div class="input-group mt-2">
                                <span class="input-group-text">Cantidad</span>
                                <input type="number"
                                       class="form-control text-center"
                                       min="1"
                                       value="@obtenerCantidad(p.Id)"
                                       @oninput="(e) => cambiarCantidad(p.Id, e)" />
                            </div>
                        </div>

                        <div class="card-footer bg-transparent border-0 text-center">
                            <button class="btn btn-success w-100 fw-semibold mt-2" @onclick="() => AgregarAlCarrito(p)">
                                🛒 Agregar al carrito
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    <!-- 🔹 Carrito -->
    <div class="carrito-container mt-5 p-4 bg-light rounded shadow-sm">

        <h4 class="fw-bold text-dark mb-3">🛍️ Carrito de compras</h4>

        @if (carritoServicio.Items.Any())
        {
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle">
                    <thead class="table-danger">
                        <tr>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>Subtotal</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in carritoServicio.Items)
                        {
                            <tr>
                                <td>@item.Nombre</td>
                                <td>$@item.PrecioUnitario</td>
                                <td>@item.Cantidad</td>
                                <td>$@item.Subtotal</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => QuitarDelCarrito(item.IdProducto)">
                                        <i class="bi bi-trash3"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- 🔹 Método de pago -->
            <div class="mt-4">
                <h5 class="fw-bold mb-2">💳 Método de pago</h5>

                <div class="form-check">
                    <input class="form-check-input" type="radio" id="efectivo" name="metodoPago"
                           value="Efectivo" @onchange="SeleccionarMetodoPago" checked="@("Efectivo" == metodoPago)">
                    <label class="form-check-label" for="efectivo">Efectivo</label>
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="radio" id="transferencia" name="metodoPago"
                           value="Transferencia" @onchange="SeleccionarMetodoPago" checked="@("Transferencia" == metodoPago)">
                    <label class="form-check-label" for="transferencia">Transferencia</label>
                </div>
            </div>

            <div class="text-end mt-4">
                <h5 class="fw-bold">Total: 💰 $@carritoServicio.ObtenerTotal()</h5>
                <button class="btn btn-primary fw-semibold" @onclick="FinalizarCompra">
                    Finalizar compra
                </button>
            </div>
        }
        else
        {
            <div class="text-center text-muted py-3">
                <p>Tu carrito está vacío. Agregá algunos productos para comenzar 🍝</p>
            </div>
        }
    </div>

</div>

<!-- 🔹 Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
    body {
        background: url('/images/fondo-nonna.jpg') no-repeat center center fixed;
        background-size: cover;
    }

    .carrito-container {
        background-color: rgba(255, 255, 255, 0.9);
    }

    .card:hover {
        transform: scale(1.03);
        transition: transform 0.2s ease-in-out;
    }

    .btn-success:hover {
        background-color: #28a745;
        transform: scale(1.05);
    }

    .btn-outline-primary:hover {
        background-color: #007bff;
        color: white;
    }
</style>

@code {
    private List<ProductoDTO>? productos;
    private Dictionary<int, int> cantidades = new(); // cantidad por producto
    private string metodoPago = "Efectivo"; // por defecto

    protected override async Task OnInitializedAsync()
    {
        var respuesta = await http.Get<List<ProductoDTO>>("api/Producto");

        if (respuesta.Error)
        {
            Console.WriteLine("Error al cargar productos");
            return;
        }

        productos = respuesta.Respuesta ?? new();
    }

    private int obtenerCantidad(int id)
    {
        return cantidades.ContainsKey(id) ? cantidades[id] : 1;
    }

    private void cambiarCantidad(int id, ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int nuevaCantidad))
            cantidades[id] = Math.Max(1, nuevaCantidad);
    }

    private void AgregarAlCarrito(ProductoDTO producto)
    {
        int cantidad = obtenerCantidad(producto.Id);

        var item = new CarritoDTO
        {
            IdProducto = producto.Id,
            Nombre = producto.Nombre ?? "",
            Descripcion = producto.Descripcion ?? "",
            PrecioUnitario = producto.PrecioBase,
            Cantidad = cantidad
        };

        carritoServicio.Agregar(item);
    }

    private void QuitarDelCarrito(int idProducto)
    {
        carritoServicio.Eliminar(idProducto);
    }

    private void SeleccionarMetodoPago(ChangeEventArgs e)
    {
        metodoPago = e.Value?.ToString() ?? "Efectivo";
        carritoServicio.AsignarMetodoPago(metodoPago);
    }

    private void FinalizarCompra()
    {
        navigationManager.NavigateTo("/pedido");
    }

    private void VolverInicio()
    {
        navigationManager.NavigateTo("/InicioUsuario");
    }
}
