@page "/carrito"
@inject CarritoServicio CarritoServicio
@inject IHTTPServicio http
@inject NavigationManager navigationManager

<h3 class="text-center mt-4 mb-4">🛒 Carrito de compras</h3>

@if (CarritoServicio.Items.Count == 0)
{
    <div class="alert alert-warning text-center">
        Tu carrito está vacío. <a href="/catalogousuario" class="alert-link">Ir al catálogo</a>
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Producto</th>
                    <th>Descripción</th>
                    <th>Precio Unitario</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in CarritoServicio.Items)
                {
                    <tr>
                        <td>@item.Nombre</td>
                        <td>@item.Descripcion</td>
                        <td>@item.PrecioUnitario.ToString("C")</td>
                        <td style="width: 120px;">
                            <input type="number" min="1"
                                   class="form-control text-center"
                                   value="@item.Cantidad"
                                   @onchange="(e) => CambiarCantidad(item.IdProducto, e)" />
                        </td>
                        <td>@item.Subtotal.ToString("C")</td>
                        <td>
                            <button class="btn btn-danger btn-sm" @onclick="() => Eliminar(item.IdProducto)">
                                <i class="bi bi-trash"></i> Quitar
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="4" class="text-end fw-bold">Total:</td>
                    <td colspan="2" class="fw-bold">@CarritoServicio.ObtenerTotal().ToString("C")</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- 🔹 Método de pago -->
    <div class="mt-4">
        <h5 class="fw-bold mb-2 text-center">💳 Método de pago</h5>

        <div class="d-flex justify-content-center gap-4">
            <div class="form-check">
                <input class="form-check-input" type="radio" id="efectivo" name="metodoPago"
                       value="Efectivo" @onchange="SeleccionarMetodoPago" checked="@("Efectivo" == metodoPago)">
                <label class="form-check-label" for="efectivo">Efectivo</label>
            </div>

            <div class="form-check">
                <input class="form-check-input" type="radio" id="transferencia" name="metodoPago"
                       value="Transferencia" @onchange="SeleccionarMetodoPago" checked="@("Transferencia" == metodoPago)">
                <label class="form-check-label" for="transferencia">Transferencia</label>
            </div>
        </div>
    </div>

    <!-- 🔹 Botones -->
    <div class="text-center mt-4">
        <button class="btn btn-secondary me-2" @onclick="VaciarCarrito">
            <i class="bi bi-x-circle"></i> Vaciar carrito
        </button>

        <button class="btn btn-success" @onclick="FinalizarCompra">
            <i class="bi bi-check-circle"></i> Finalizar compra
        </button>
    </div>
}

<!-- Bootstrap icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

@code {
    private string metodoPago = "Efectivo";

    private void CambiarCantidad(int idProducto, ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int nuevaCantidad))
        {
            CarritoServicio.ActualizarCantidad(idProducto, Math.Max(1, nuevaCantidad));
        }
    }

    private async Task Eliminar(int id)
    {
        CarritoServicio.Eliminar(id);
    }

    private void VaciarCarrito()
    {
        CarritoServicio.Vaciar();
    }

    private void SeleccionarMetodoPago(ChangeEventArgs e)
    {
        metodoPago = e.Value?.ToString() ?? "Efectivo";
        CarritoServicio.AsignarMetodoPago(metodoPago);
    }

    private async Task FinalizarCompra()
    {
        var pedido = new CrearPedidoDTO
        {
            Fecha_Pedido = DateTime.Now,
            Fecha_Entrega = DateTime.Now.AddDays(2),
            MetodoPago = metodoPago,
            Total = CarritoServicio.ObtenerTotal(),
            Productos = CarritoServicio.Items.Select(item => new CrearDetalle_PedidoDTO
            {
                Nombre = item.Nombre,
                Cantidad = item.Cantidad,
                Precio_Unitario = item.PrecioUnitario
            }).ToList()
        };

        var response = await http.Post<CrearPedidoDTO, int>("api/Pedido", pedido);

        if (response.Exitoso)
        {
            CarritoServicio.Vaciar();
            navigationManager.NavigateTo("/pedidoexitoso");
        }
        else
        {
            Console.WriteLine("❌ Error al guardar el pedido: " + response.Mensaje);
        }
    }
}
